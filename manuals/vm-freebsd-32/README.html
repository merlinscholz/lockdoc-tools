<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <link rel="stylesheet" href="pandoc.css">
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<!-- MarkdownTOC -->
<ul>
<li><a href="#vorbereitung-und-installation-von-freebsd-unter-qemu">Vorbereitung und Installation von FreeBSD unter QEMU</a>
<ul>
<li><a href="#vorbereitung">Vorbereitung</a></li>
<li><a href="#installation">Installation</a>
<ul>
<li><a href="#booten">Booten</a></li>
<li><a href="#beginn-der-installation">Beginn der Installation</a></li>
<li><a href="#keyboard-konfiguration">Keyboard konfiguration</a></li>
<li><a href="#konfiguration">Konfiguration</a></li>
<li><a href="#partitionierung">Partitionierung</a></li>
<li><a href="#eigentliche-installation">Eigentliche Installation</a></li>
<li><a href="#root-passwort">Root-Passwort</a></li>
<li><a href="#netzwerk">Netzwerk</a></li>
<li><a href="#zeiteinstellung">Zeiteinstellung</a></li>
<li><a href="#services">Services</a></li>
<li><a href="#hardening">Hardening</a></li>
<li><a href="#weitere-benutzer">Weitere Benutzer</a></li>
<li><a href="#abschluss">Abschluss</a></li>
<li><a href="#fertiges-os">Fertiges OS</a></li>
<li><a href="#links">Links</a></li>
</ul></li>
</ul></li>
<li><a href="#freebsd-f%C3%BCr-lockdoc-vorbereiten">FreeBSD für LockDoc vorbereiten</a>
<ul>
<li><a href="#erforderliche-pakete-installieren">Erforderliche Pakete installieren</a></li>
<li><a href="#userland-einrichten">Userland einrichten</a></li>
<li><a href="#installation-des-init-skripts">Installation des Init-Skripts</a></li>
<li><a href="#installation-des-benchmark-skripts">Installation des Benchmark-Skripts</a></li>
<li><a href="#installation-der-benchmark-tools">Installation der Benchmark-Tools</a></li>
<li><a href="#konfiguration-und-%C3%9Cbersetzen-des-freebsd-kernels">Konfiguration und Übersetzen des FreeBSD Kernels</a>
<ul>
<li><a href="#konfiguration-1">Konfiguration</a></li>
<li><a href="#%C3%9Cbersetzen-au%C3%9Ferhalb-des-source-trees">Übersetzen außerhalb des Source-Trees</a></li>
<li><a href="#%C3%9Cbersetzen-im-source-tree">Übersetzen im Source-Tree</a></li>
</ul></li>
<li><a href="#links-1">Links</a></li>
</ul></li>
</ul>
<!-- /MarkdownTOC -->
<p><a id="vorbereitung-und-installation-von-freebsd-unter-qemu"></a></p>
<h1 id="vorbereitung-und-installation-von-freebsd-unter-qemu">Vorbereitung und Installation von FreeBSD unter QEMU</h1>
<p><a id="vorbereitung"></a></p>
<h2 id="vorbereitung">Vorbereitung</h2>
<p>Zunächst laden wir ein Installer-Image von <a href="https://www.freebsd.org/where.html">freebsd.org/where.html</a><br />
herunter. Wir verwenden das DVD-Image für <a href="https://download.freebsd.org/ftp/releases/i386/i386/ISO-IMAGES/11.2/FreeBSD-11.2-RELEASE-i386-dvd1.iso">FreeBSD 11.2</a> für i386.</p>
<p>Danach erstellen wir entsprechend der geladenen Version ein VM-Image:</p>
<p><code>qemu-img create -f raw freebsd.img 20G</code></p>
<p>QEMU kann manuel gestartet werden:</p>
<p><code>qemu-system-x86_64 -smp 1 -boot c -cdrom /path/to/FreeBSD-11.2-RELEASE-i386-dvd1.iso -m 512 -hda /path/to/freebsd.img</code></p>
<p>Alternativ kann man die virtuelle Maschine via Virt-Manager erstellen.</p>
<p><a id="installation"></a></p>
<h2 id="installation">Installation</h2>
<p><a id="booten"></a></p>
<h3 id="booten">Booten</h3>
<p>Wir booten das Installer-Image in den gewünschten Modus. Der Standardfall ist dabei<br />
<code>multi user</code>. Zu den Modis siehe auch<br />
<a href="https://www.freebsd.org/doc/handbook/boot-introduction.html#boot-singleuser">FreeBSD Handbook</a>.</p>
<p><img src="./img/install-01.png" alt="alt text" /></p>
<p><a id="beginn-der-installation"></a></p>
<h3 id="beginn-der-installation">Beginn der Installation</h3>
<p>Danach wählen wir <code>Install</code> aus, um die Installation zu beginnen.</p>
<p><img src="./img/install-02.png" alt="alt text" /></p>
<p><a id="keyboard-konfiguration"></a></p>
<h3 id="keyboard-konfiguration">Keyboard konfiguration</h3>
<p>Konfiguration des Tastatur Layouts (Default ist US).</p>
<p><img src="./img/install-03.png" alt="alt text" /></p>
<p>Wir haben <em>German</em> gewählt.</p>
<p><img src="./img/install-04.png" alt="alt text" /></p>
<p><a id="konfiguration"></a></p>
<h3 id="konfiguration">Konfiguration</h3>
<p>Danach geben wir der Maschine einen Namen.</p>
<p><img src="./img/install-05.png" alt="alt text" /></p>
<p>Und haben nun die Auswahl darüber, was installiert werden soll. Entgegen des Screenshots ist das Paket <code>src</code> nicht erforderlich, da wir unseren eigenen FreeBSD-Tree nutzen.<br />
Ansonsten ist noch die Option <code>ports</code> zu erwähnen, die eine Ansammlung<br />
von Scripten entspricht, die automatisiert Software (z.B. X11), die nicht direkt zu FreeBSD<br />
gehört, laden, übersetzt und installiert. Der Rest sollte selbsterklärend sein.</p>
<p>Die Komponenten lassen sich auch alle nachträglich installieren.</p>
<p><img src="./img/install-06.png" alt="alt text" /></p>
<p><a id="partitionierung"></a></p>
<h3 id="partitionierung">Partitionierung</h3>
<p>Anschließend partitionieren wir unser VM-Image. Auch wenn <code>UFS</code> eher für<br />
eine VM zu empfehlen ist, da <code>ZFS</code> wesentlich mehr RAM und Rechenleistung benötigt, ist hier <code>ZFS</code> zu wählen!<br />
Wird <code>ZFS</code> eingesetzt, kann man das Image im Zweifel einfach unter Linux einhängen und bearbeiten. Mit <code>UFS</code> geht das nicht ohne Weiteres.<br />
Wenn geht es auch nur lesend. Die Unterstützung für schreibenden Zugriff ist noch sehr experimentell.</p>
<p><img src="./img/install-07.png" alt="alt text" /><br />
<img src="./img/install-08.png" alt="alt text" /><br />
<img src="./img/install-09.png" alt="alt text" /><br />
<img src="./img/install-10.png" alt="alt text" /><br />
<img src="./img/install-11.png" alt="alt text" /></p>
<p><a id="eigentliche-installation"></a></p>
<h3 id="eigentliche-installation">Eigentliche Installation</h3>
<p>Jetzt kopiert und entpackt der Installer die Daten von dem Installer-Image auf das VM-Image.<br />
Das kann je nach Maschine und Installer-Image 3-10 Minuten dauern.</p>
<p><img src="./img/install-12.png" alt="alt text" /></p>
<p><a id="root-passwort"></a></p>
<h3 id="root-passwort">Root-Passwort</h3>
<p>Jetzt noch das root-Passwort festlegen und wir sind fast fertig.</p>
<p><img src="./img/install-15.png" alt="alt text" /></p>
<p><a id="netzwerk"></a></p>
<h3 id="netzwerk">Netzwerk</h3>
<p>Entsprechende Netzwerk Einstellungen sind nur notwendig, falls Software<br />
(z.B. <code>vim</code>) nachinstalliert werden soll oder falls für die eigentliche<br />
Aufgabe Netzwerk notwendig ist.</p>
<p><img src="./img/install-16.png" alt="alt text" /><br />
<img src="./img/install-17.png" alt="alt text" /><br />
<img src="./img/install-18.png" alt="alt text" /><br />
<img src="./img/install-19.png" alt="alt text" /></p>
<p>IPv6 können wir überspringen, da die Uni (und das ITMC) eh nicht daran glauben.</p>
<p><img src="./img/install-20.png" alt="alt text" /></p>
<p>Die DNS Einstellungen kann man auf den voreingestellten Werten belassen.</p>
<p><img src="./img/install-21.png" alt="alt text" /></p>
<p><a id="zeiteinstellung"></a></p>
<h3 id="zeiteinstellung">Zeiteinstellung</h3>
<p><img src="./img/install-22.png" alt="alt text" /><br />
<img src="./img/install-23.png" alt="alt text" /><br />
<img src="./img/install-24.png" alt="alt text" /><br />
<img src="./img/install-25.png" alt="alt text" /></p>
<p>Falls notwendig setzen des korrekten Datums und Uhrzeit.</p>
<p><img src="./img/install-26.png" alt="alt text" /><br />
<img src="./img/install-27.png" alt="alt text" /></p>
<p><a id="services"></a></p>
<h3 id="services">Services</h3>
<p>Hier kann der Default auch belassen werden.<br />
<code>local_unbound</code> ist <a href="http://hauweele.net/~gawen/blog/?tag=local_unbound">a secure, lightweight and high performance validating, recursive, and caching DNS resolver. It performs DNSSEC validation and it is also really easy to configure</a></p>
<p><img src="./img/install-28.png" alt="alt text" /></p>
<p><a id="hardening"></a></p>
<h3 id="hardening">Hardening</h3>
<p><img src="./img/install-29.png" alt="alt text" /></p>
<p><a id="weitere-benutzer"></a></p>
<h3 id="weitere-benutzer">Weitere Benutzer</h3>
<p>Hier sollte direkt ein Nutzer angelegt werden.<br />
Analog zu Linux können wir später jeder Zeit neue Nutzer mit <code>adduser</code> anlegen.</p>
<p><img src="./img/install-30.png" alt="alt text" /></p>
<p><a id="abschluss"></a></p>
<h3 id="abschluss">Abschluss</h3>
<p>Im Anschluss haben wir noch einmal die Möglichkeit diverse Einstellungen zu ändern.<br />
<img src="./img/install-31.png" alt="alt text" /></p>
<p>Außerdem erhalten wir noch die Option vor dem Neustart mit einer Shell im neuen System eigene Änderungen vorzunehmen.</p>
<p><img src="./img/install-32.png" alt="alt text" /><br />
<img src="./img/install-33.png" alt="alt text" /><br />
<img src="./img/install-34.png" alt="alt text" /></p>
<p><a id="fertiges-os"></a></p>
<h3 id="fertiges-os">Fertiges OS</h3>
<p>Nach dem Neustart können wir uns anmelden:</p>
<p><img src="./img/install-35.png" alt="alt text" /><br />
<img src="./img/install-36.png" alt="alt text" /><br />
<img src="./img/install-37.png" alt="alt text" /></p>
<p><a id="links"></a></p>
<h3 id="links">Links</h3>
<p>Nützliche Links:</p>
<ul>
<li><a href="http://web.archive.org/web/20180602143516/https://www.freebsd.org/doc/handbook/bsdinstall-start.html" class="uri">http://web.archive.org/web/20180602143516/https://www.freebsd.org/doc/handbook/bsdinstall-start.html</a><br />
Handbuch zu installation von FreeBSD (Achtung: Die Bilder sind etwas veraltert.).</li>
<li><a href="http://web.archive.org/web/20180602143507/https://www.freebsd.org/doc/handbook/svn.html" class="uri">http://web.archive.org/web/20180602143507/https://www.freebsd.org/doc/handbook/svn.html</a> Anleitung Komponenten wie <strong>ports</strong> oder <strong>src</strong> nachinstalliert.</li>
</ul>
<p><a id="freebsd-f%C3%BCr-lockdoc-vorbereiten"></a></p>
<h1 id="freebsd-fur-lockdoc-vorbereiten">FreeBSD für LockDoc vorbereiten</h1>
<p>Damit LockDoc mit FreeBSD funktioniert, müssen noch ein paar Skripte und Programme installiert sowie Einstellungen vorgenommen werden.</p>
<p><a id="erforderliche-pakete-installieren"></a></p>
<h2 id="erforderliche-pakete-installieren">Erforderliche Pakete installieren</h2>
<p>Mit dem folgenden Befehl lassen sich als <strong>root</strong> alle notwendigen Programme installieren.</p>
<pre><code># pkg install &lt;paketname&gt;</code></pre>
<p>Für unser Setup wurden u.a. folgende Pakete installiert:</p>
<pre><code># pkg install vim mosh byobu git bash linux_base-c7-7.4.1708_6 sysbench-1.0.14 sudo</code></pre>
<p><strong>Achtung</strong><br />
Ggf. muss der Versions-String für einzelne Pakete angepasst werden.</p>
<p><a id="userland-einrichten"></a></p>
<h2 id="userland-einrichten">Userland einrichten</h2>
<p>Analog zu Linux kann man einem Nutzer ermöglichen, root-Rechte zu erlangen. Hierzu muss der Nutzer Mitglied der Gruppe <code>wheel</code> sein.</p>
<pre><code>pw groupmod -m al -n wheel</code></pre>
<p>In <code>/usr/local/etc/sudoers</code> muss nun die Zeile <code>%wheel ALL=(ALL) ALL</code> auskommentiert werden.</p>
<p>Da manche Programme unter FreeBSD an anderer Stelle im Dateisystem als unter Linux liegen, erstellen wir Symlinks, damit dasselbe Benchmark-Skript nutzen können.</p>
<pre><code># ln -s /usr/local/bin/bash /bin/
# ln -s /usr/local/bin/sysbench /usr/bin/</code></pre>
<p>Für den Linux-Kompatibilitätslayer sind Linux-spezifische Dateisysteme erforderlich. Diese müssen in der <code>/etc/fstab</code> eingetragen werden:</p>
<pre><code>linproc         /compat/linux/proc  linprocfs  rw,late  0       0
linsysfs        /compat/linux/sys   linsysfs        rw      0       0
tmpfs           /compat/linux/dev/shm  tmpfs   rw,mode=1777    0       0</code></pre>
<p>Die dafür nötigen Kernel-Module sollten automatisch geladen werden.</p>
<p><a id="installation-des-init-skripts"></a></p>
<h2 id="installation-des-init-skripts">Installation des Init-Skripts</h2>
<p>Die Skripte finden sich im tools-Repo unter <code>manuals/vm-freebsd-32/scripts</code>. Diese müssen in die VM nach <code>/lockdoc</code> kopiert werden.<br />
Anschließend muss das neue Init-Skript im Bootloader vermerkt werden. Hierzu muss folgende Zeile in die Datei <code>/boot/loader.conf</code> eingetragen werden:<br />
Da das ZFS-Dateisystem für <code>/home</code> einen separaten Pool anlegt, der zum Startzeitpunkt noch nicht eingehängt ist, muss das Init-Skript im root-Dateisystem liegen.</p>
<pre><code>init_script=&quot;/lockdoc/boot.init.sh&quot;</code></pre>
<p>Ggf. sind die Zeilen, die ebensfalls <code>init_script</code> setzen, auszukommentieren.<br />
Jetzt wird bei jedem Start, nachdem der Kernel geladen wurde, als erstes dieses Script ausgeführt.<br />
<strong>Achtung:</strong> Sollte der Nutzer <strong>nicht</strong> <code>al</code> lauten, müssen die Init-Skripte angepasst werden.<br />
Sollte der Nutzer beim Startet <strong>nicht</strong> innerhalb von fünf Sekunden einen beliebigen Buchstaben drücken, wird der Benchmark gestartet.<br />
Andernfalls wird das gewöhnliche FreeBSD-Userland gestartet.</p>
<p><a id="installation-des-benchmark-skripts"></a></p>
<h2 id="installation-des-benchmark-skripts">Installation des Benchmark-Skripts</h2>
<p>Das Skript <code>run-bench.sh</code> befindet sich im tools-Repo unter <code>manuals/vm-linux-32/scripts</code>. Dies muss in der VM nach <code>/home/$NUTZER</code> kopiert werden.</p>
<p><a id="installation-der-benchmark-tools"></a></p>
<h2 id="installation-der-benchmark-tools">Installation der Benchmark-Tools</h2>
<p>Sowohl in der Linux- als auch in der FreeBSD-VM verwenden wir ein Subset des Linux-Test-Project (LTP) für unsere Benchmarksuite.<br />
Der Quellcode findet sich unter <code>https://github.com/linux-test-project/ltp.git</code>. Aktuell setzen wir Revision <code>5f8ca6cf</code> ein.<br />
Mit Hilfe des Linux-Kompatibilitätslayers laufen die Programme aus dem LTP problemlos unter FreeBSD.<br />
Allerdings müssen sie unter Linux übersetzt und in das Verzeichnis <code>/opt/kernel/ltp-bin</code> installiert werden. Vor dem Übersetzen ist noch der Patch <code>ltp-lockdebug.patch</code> aus <code>manuals/vm-linux-32/</code> anzuwenden.<br />
Das Verzeichnis kann man anschließend an dieselbe Position in die FreeBSD-VM kopieren.</p>
<p><a id="konfiguration-und-%C3%9Cbersetzen-des-freebsd-kernels"></a></p>
<h2 id="konfiguration-und-ubersetzen-des-freebsd-kernels">Konfiguration und Übersetzen des FreeBSD Kernels</h2>
<p>Zuerst muss unsere eigene Version des FreeBSD-Trees ausgechecked werden. Wir verwenden einen bestimmten Branch.</p>
<pre><code>git clone git@gitos.cs.tu-dortmund.de:lockdoc/freebsd.git -b releng/11.2-lockdoc /opt/kernel/freebsd/src</code></pre>
<p>** Achtung: ** Bevor irgendein selbstgebauter Kernel installiert wird, sollte der Standard-Kernel gesichert werden:</p>
<pre><code>sudo cp -r /boot/kernel /boot/kernel.bak</code></pre>
<p>Bei einem <code>make install</code> wird der aktuelle Kernel nach <code>/boot/kernel.old</code> kopiert und der neue Kernel in <code>/boot/kernel</code> installiert.<br />
Zusätzlich kann man in <code>/boot/loader.conf</code> in der Zeile <code>kernels=&quot;kernel kernel.old</code> noch <code>kernel.bak</code> hinzufügen, damit der Standard-Kernel direkt über den Bootloader erreichbar ist.<br />
<a id="konfiguration-1"></a></p>
<h3 id="konfiguration-1">Konfiguration</h3>
<p>Die Konfiguration für LockDoc befindet sich bereits in <code>/opt/kernel/freebsd/src/sys/i386/conf</code>. Daher ist nichts weiter zu tun, sofern diese Konfiguration verwendet werden soll.</p>
<p>Alternativ kann auch mit einer Standard-Konfiguration begonnen werden:</p>
<pre><code># cd /opt/kernel/freebsd/src/sys/i386/conf
# cp GENERIC LOCKDOC</code></pre>
<p>Danach kann die Konfiguration angepasst werden, um z.B. einige Sub-Systeme zu entfernen.</p>
<p><a id="%C3%9Cbersetzen-au%C3%9Ferhalb-des-source-trees"></a></p>
<h3 id="ubersetzen-auerhalb-des-source-trees">Übersetzen außerhalb des Source-Trees</h3>
<p>Damit wirklich nur der Kernel übersetzt wird und nicht noch Abhängigkeiten aus dem FreeBSD-Tree, kann man mit einer Konfiguration<br />
einen spezialisierten Source-Tree erzeugen und diesen anschließend übersetzen:</p>
<pre><code># cd /opt/kernel/freebsd/src/conf
# config -d /opt/kernel/freebsd/obj -I `pwd` `pwd`/LOCKDOC
# cd /$OBJDIR
# MODULES_OVERRIDE=&quot;&quot; make [-j X]
# sudo -E MODULES_OVERRIDE=&quot;&quot; make install</code></pre>
<p>Es ist wichtig, die Variable <code>MODULES_OVERRIDE=&quot;&quot;</code> zu setzen. Nur so wird verhindert, dass alle Module gebaut werden - was das Standard-Verhalten ist.<br />
Effektiv werden gar keine separaten Kernel-Module gebaut. Alle erforderlichen Treiber und co. werden über die Konfiguration in das Kernel-Image gelinkt.</p>
<p><a id="%C3%9Cbersetzen-im-source-tree"></a></p>
<h3 id="ubersetzen-im-source-tree">Übersetzen im Source-Tree</h3>
<p>Möchte man einfach den Kernel innerhalb des FreeBSD-Trees bauen, genügen folgende Befehle:</p>
<pre><code># cd /usr/src
# make buildkernel KERNCONF=LOCKDOC
# make installkernel KERNCONF=LOCKDOC</code></pre>
<p>Außerdem kann mit dem Flag <code>-DKERNFAST</code> das Übersetzen beschleunigt werden, in<br />
dem nur die Übersetzungseinheiten neu gebaut werden, deren Konfiguration oder Quellcode sich<br />
geändert hat.</p>
<pre><code># cd /usr/src
# make buildkernel -DKERNFAST KERNCONF=LOCKDOC
# make installkernel KERNCONF=LOCKDOC</code></pre>
<p><a id="links-1"></a></p>
<h2 id="links-1">Links</h2>
<ul>
<li><a href="http://web.archive.org/web/20180602150338/https://www.freebsd.org/doc/handbook/kernelconfig-config.html" class="uri">http://web.archive.org/web/20180602150338/https://www.freebsd.org/doc/handbook/kernelconfig-config.html</a> ausführliche Anleitung zur Konfiguration des Kernels.</li>
<li><a href="http://web.archive.org/web/20180602152745/https://www.freebsd.org/doc/handbook/kernelconfig-building.html" class="uri">http://web.archive.org/web/20180602152745/https://www.freebsd.org/doc/handbook/kernelconfig-building.html</a> ausführliche Anleitung zur Übersetzung des Kernels.</li>
</ul>
<p>Written by Daniel Korner 2018; extended by Alexander Lochmann 2018</p>
</body>
</html>
